<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جنریتور پیشرفته کد HTML</title>
    
    <!-- استایل‌های ویرایشگر Trumbowyg از CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/trumbowyg.min.css">

    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d;
            --success-color: #28a745; --danger-color: #dc3545;
            --light-bg: #f8f9fa; --dark-text: #212529; --border-color: #dee2e6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; background-color: #e9ecef; color: var(--dark-text);
            padding: 20px; direction: rtl;
        }
        .generator-container {
            max-width: 900px; margin: 0 auto; background-color: #fff;
            padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2 { color: var(--dark-text); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .block-editor {
            border: 1px solid var(--border-color); border-radius: 8px;
            padding: 20px; margin-bottom: 20px; background-color: var(--light-bg);
            position: relative;
        }
        .block-editor label { font-weight: 600; display: block; margin-bottom: 5px; }
        .block-editor input, .block-editor textarea, .block-editor select {
            width: 100%; padding: 10px; border-radius: 5px;
            border: 1px solid var(--border-color); font-family: inherit; font-size: 1rem;
            margin-bottom: 15px;
        }
        .block-editor .code-input { direction: ltr; text-align: left; font-family: monospace; }
        .form-row { display: flex; gap: 15px; align-items: flex-end; }
        .form-row > div { flex: 1; }
        .remove-block-btn {
            position: absolute; top: 15px; left: 15px;
            background-color: var(--danger-color); color: white;
            border: none; border-radius: 50%; width: 30px; height: 30px;
            cursor: pointer; font-size: 1.2rem; display: flex;
            align-items: center; justify-content: center; line-height: 1;
            transition: background-color 0.2s ease; z-index: 10;
        }
        .remove-block-btn:hover { background-color: #c82333; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 5px;
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #218838; }
        .output-area { margin-top: 20px; }
        #output-code {
            width: 100%; min-height: 300px; font-family: monospace;
            direction: ltr; text-align: left; padding: 15px;
            border-radius: 5px; border: 1px solid var(--border-color);
            background-color: #2b303b; color: #c0c5ce;
        }
        /* استایل‌های خود ویرایشگر برای خوانایی بهتر */
        .trumbowyg-box { margin-bottom: 15px !important; }
    </style>
</head>
<body>

    <div class="generator-container">
        <h1>مولد کد HTML</h1>
        <p>برای فیلد توضیحات، یک ویرایشگر پیشرفته بارگذاری می‌شود. اگر در دسترس نباشد، یک فیلد متنی ساده نمایش داده خواهد شد.</p>

        <div id="blocks-container"></div>

        <button id="add-block-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 30px;">افزودن بلوک جدید (+)</button>

        <hr>

        <h2>خروجی نهایی</h2>
        <button id="generate-btn" class="btn btn-success" style="width: 100%;">1. تولید کد نهایی HTML (مینیمال)</button>

        <div class="output-area">
            <textarea id="output-code" readonly placeholder="کد نهایی در اینجا نمایش داده می‌شود..."></textarea>
            <button id="copy-output-btn" class="btn btn-secondary" style="width: 100%; margin-top: 10px; background-color: var(--secondary-color); color:white;">2. کپی کد نهایی</button>
        </div>
    </div>

    <template id="block-template">
        <div class="block-editor">
            <button class="remove-block-btn" title="حذف این بلوک">&times;</button>
            <div class="form-row">
                <div>
                    <label>عنوان توضیحات</label>
                    <input type="text" class="title-input" placeholder="مثلا: کد جاوا اسکریپت">
                </div>
                <div>
                    <label>جهت‌گیری کلی بلوک</label>
                    <select class="block-dir-select">
                        <option value="rtl" selected>راست به چپ (RTL)</option>
                        <option value="ltr">چپ به راست (LTR)</option>
                    </select>
                </div>
            </div>
            <label>متن توضیحات (پشتیبانی از ویرایشگر پیشرفته)</label>
            <textarea class="description-input" placeholder="توضیحات مربوط به کد را اینجا بنویسید..."></textarea>
            
            <label>کد برای کپی</label>
            <textarea class="code-input" placeholder="function hello() { ... }"></textarea>
        </div>
    </template>

    <!-- اسکریپت‌های ویرایشگر Trumbowyg و وابستگی آن (jQuery) از CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/trumbowyg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/langs/fa.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const blocksContainer = document.getElementById('blocks-container');
            const addBlockBtn = document.getElementById('add-block-btn');
            const blockTemplate = document.getElementById('block-template');
            
            // تابع برای افزودن یک بلوک و مقداردهی اولیه ویرایشگر
            function addBlock() {
                const clone = blockTemplate.content.cloneNode(true);
                const descriptionTextarea = clone.querySelector('.description-input');
                blocksContainer.appendChild(clone);
                
                // Fallback هوشمند: اگر ویرایشگر در دسترس بود، آن را فعال کن
                try {
                    if (jQuery && jQuery.fn.trumbowyg) {
                        $(descriptionTextarea).trumbowyg({
                            lang: 'fa',
                            btns: [
                                ['viewHTML'], ['undo', 'redo'], ['formatting'],
                                ['strong', 'em', 'del'], ['link'], ['insertImage'],
                                ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'],
                                ['unorderedList', 'orderedList'], ['horizontalRule'], ['removeformat']
                            ]
                        });
                    }
                } catch (e) {
                    console.warn('Trumbowyg editor could not be loaded. Falling back to standard textarea.', e);
                }
            }

            addBlock(); // افزودن یک بلوک اولیه

            addBlockBtn.addEventListener('click', addBlock);

            blocksContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-block-btn')) {
                    e.target.closest('.block-editor').remove();
                }
            });

            function escapeHTML(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }
            
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.addEventListener('click', () => {
                let contentHtml = '';
                document.querySelectorAll('.block-editor').forEach(editor => {
                    const title = escapeHTML(editor.querySelector('.title-input').value);
                    const blockDir = editor.querySelector('.block-dir-select').value;
                    const code = escapeHTML(editor.querySelector('.code-input').value);
                    const descriptionTextarea = editor.querySelector('.description-input');
                    
                    let descriptionContent = '';
                    // بررسی کن که ویرایشگر فعال شده یا نه
                    if ($(descriptionTextarea).trumbowyg) {
                         // اگر فعال شده، محتوای HTML را بگیر
                        descriptionContent = $(descriptionTextarea).trumbowyg('html');
                    } else {
                        // اگر نه (Fallback)، محتوای متنی ساده را بگیر و فرمت کن
                        descriptionContent = escapeHTML(descriptionTextarea.value).replace(/\n/g, '<br />');
                    }

                    contentHtml += `
        <!-- Code Block Wrapper -->
        <div class="code-wrapper" dir="${blockDir}">
            <div class="description">
                <h4 class="description-title">${title}</h4>
                <div class="description-content">${descriptionContent}</div>
            </div>
            <div class="code-block">
                <button class="copy-button">کپی</button>
                <pre><code>${code}</code></pre>
            </div>
        </div>`;
                });
                document.getElementById('output-code').value = getFinalHtmlTemplate(contentHtml.trim());
            });
            
            const copyOutputBtn = document.getElementById('copy-output-btn');
            copyOutputBtn.addEventListener('click', () => {
                const outputCode = document.getElementById('output-code');
                outputCode.select();
                document.execCommand('copy');
                const originalText = copyOutputBtn.innerText;
                copyOutputBtn.innerText = 'کپی شد!';
                setTimeout(() => { copyOutputBtn.innerText = originalText; }, 2000);
            });

            function getFinalHtmlTemplate(content) {
                const minifiedCSS = `*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;line-height:1.6;background-color:#f8f9fa;color:#212529;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}.container{background-color:#fff;padding:30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.08);max-width:800px;width:90%}.code-wrapper{margin-bottom:30px}.code-wrapper:last-child{margin-bottom:0}.description{margin-bottom:15px}.description-title{font-size:1.1rem;font-weight:600;color:#343a40;margin-bottom:8px}.description-content{color:#495057;font-size:.95rem;line-height:1.7}.description-content p,.description-content ul,.description-content ol{margin-bottom:10px}.code-block{background-color:#e9ecef;border:1px solid #ced4da;border-radius:8px;padding:15px;overflow:hidden;direction:ltr;text-align:left;position:relative}.code-block pre{margin:0;white-space:pre-wrap;word-wrap:break-word;font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,Courier,monospace;font-size:.9rem;color:#343a40;overflow-x:auto;padding-top:10px}.copy-button{position:absolute;top:10px;right:10px;background-color:#6c757d;color:#fff;border:none;padding:5px 10px;border-radius:5px;font-size:.85rem;cursor:pointer;opacity:.7;transition:opacity .2s ease,background-color .2s ease}.code-block:hover .copy-button{opacity:1}.copy-button.copied{background-color:#28a745;opacity:1}.copy-button:disabled{cursor:default}`;
                const minifiedJS = `function fallbackCopyTextToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",t.style.opacity="0",t.setAttribute("readonly",""),document.body.appendChild(t),t.select();let o=!1;try{o=document.execCommand("copy")}catch(e){console.error("Fallback copy failed:",e)}return document.body.removeChild(t),o}document.querySelectorAll(".copy-button").forEach(e=>{const t=e.innerText;e.addEventListener("click",()=>{const o=e.closest(".code-block").querySelector("pre code");if(!o)return;const c=o.innerText;function n(o,n){e.innerText=o,e.classList.add(n),e.disabled=!0,setTimeout(()=>{e.innerText=t,e.classList.remove(n),e.disabled=!1},2e3)}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(c).then(()=>n("کپی شد!","copied"),()=>{fallbackCopyTextToClipboard(c)?n("کپی شد!","copied"):n("خطا!","error")}):fallbackCopyTextToClipboard(c)?n("کپی شد!","copied"):n("خطا!","error")})});`;
                return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>کپی متن</title><style>${minifiedCSS}</style></head><body><div class="container">${content}</div><script>${minifiedJS}<\/script></body></html>`;
            }
        });
    </script>
</body>
</html>